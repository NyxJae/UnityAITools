# 需求文档 - K3 框架 UI 预制体查询与编辑

## 1. 项目现状与核心目标

### 1.1 用户需求简述

本项目 UI 框架使用私有的 K3 框架（基于 Unity UGUI 扩展），所有 UI 组件都是 K3 框架组件（如 K3Button、K3Label、K3Image 等），而不是 Unity 原生的 Button、Text、Image。

需要提供两个专门的命令来查询和编辑 K3 框架组件：

1. **k3prefab.queryByK3Id**: 通过 K3ID 查询 K3 组件信息
2. **k3prefab.setComponentProperties**: 修改 K3 组件的属性参数

### 1.2 项目现状

- 项目已有完善的 AgentCommands 命令系统，位于`Code/Assets/Editor/AgentCommands/`
- 已实现预制体查看和编辑功能：`prefab.queryHierarchy`、`prefab.queryComponents`、`prefab.setGameObjectProperties`
- K3 框架有自己的组件 ID 系统（K3ID），在 Dialog/Panel 级别唯一
- K3ID 是 uint 类型，存储在 K3Property 中，用于在 Lua 代码中通过 ID 获取组件
- **插件化架构**: k3prefab 命令通过 `AgentCommands.Plugins.K3Prefab.K3PrefabPlugin` 提供(Priority 100)
- **实现文件**: `Code/Assets/Editor/AgentCommands/Plugins/K3Prefab/K3PrefabPlugin.cs`
- **可移除性**: K3Prefab 插件是完全可移除的项目专用能力,删除 K3Prefab 文件夹不影响项目编译

### 1.3 核心目标

- 让外部工具通过 K3ID 快速定位和查询 K3 组件
- 支持按 K3ID 查询，并返回该 K3 组件的完整信息（GameObject 路径、GameObject 属性、K3 组件详细参数）
- 支持按 K3ID 和索引精确定位并修改 K3 组件属性
- 提供乐观锁机制，验证旧值后才修改，避免误修改
- 由于这些功能是 K3 框架特化的，需要独立成模块，便于后续移除（不适配其他项目）

### 1.4 K3 框架核心概念

**K3ID 唯一性范围**：

- K3ID 在**Dialog/Panel 级别唯一**（不是 GameObject 级别，也不是预制体级别）
- 每个 K3Dialog 和 K3PanelEx 容器都维护自己的`childrenDict`字典（ID 到组件的映射）
- 同一个 Dialog 中所有 K3 组件的 ID 必须唯一
- 不同 Dialog/Panel 之间可以有相同的 K3ID

**K3 组件类型**：

项目中的 K3 组件包括但不限于：

- **基础组件**：K3Button、K3Label、K3Image、K3Edit、K3CheckBox、K3Slider
- **容器组件**：K3Dialog、K3Panel、K3Tab
- **特殊组件**：K3ListView、K3Itembox、K3ProgressBar 等

## 2. 范围与边界

### 2.1 功能点简述

#### 命令 1: k3prefab.queryByK3Id

- [ ] 接收预制体路径和 K3ID，定位目标 K3 组件
- [ ] 自动遍历预制体中所有 K3Dialog/K3PanelEx 容器，在它们的 childrenDict 中查找 K3ID
- [ ] 支持按组件类型过滤（如只查询 K3Button 类型的组件）
- [ ] 返回所有匹配的 K3 组件（可能有多个，因为不同容器可以有相同 K3ID）
- [ ] 每个匹配组件包含：index 索引、GameObject 层级路径、GameObject 属性、K3 组件详细信息

#### 命令 2: k3prefab.setComponentProperties

- [ ] 接收预制体路径、K3ID、索引（可选）、修改数组
- [ ] 通过 K3ID 和索引精确定位到唯一的 K3 组件
- [ ] 支持批量修改多个属性
- [ ] 逐属性验证旧值，不匹配的属性跳过，匹配的才修改
- [ ] 返回每个属性的修改结果（成功/失败/跳过）
- [ ] 修改后自动保存预制体

### 2.2 排除项

- 不支持通过 GameObject 路径查询（使用现有的`prefab.queryComponents`）
- 不支持修改 GameObject 属性（使用现有的`prefab.setGameObjectProperties`）
- 不支持添加/删除 K3 组件
- 不支持修改运行时实例（仅支持预制体文件）
- 不支持 K3 框架之外的其他 Unity 组件

### 2.3 模块化要求

**独立模块设计**：

```
Assets/Editor/AgentCommands/
├── K3Prefab/                              # 【新增】K3预制体特化模块
│   ├── Handlers/
│   │   ├── K3PrefabQueryByK3IdHandler.cs          # K3ID查询处理器
│   │   └── K3PrefabSetComponentPropertiesHandler.cs # K3组件属性修改处理器
│   ├── Utils/
│   │   ├── K3ComponentFinder.cs                    # K3组件查找工具
│   │   ├── K3ComponentPropertyReader.cs            # K3组件属性读取
│   │   └── K3ComponentPropertyModifier.cs           # K3组件属性修改
│   └── Models/
│       └── K3ComponentModification.cs               # 修改请求模型
└── ... (其他通用模块)
```

**可移除性**：

- 整个`K3Prefab`文件夹可以独立删除，不影响其他 AgentCommands 功能
- 不依赖 K3 框架之外的特定项目逻辑
- 清晰的模块边界，便于后续移植或移除

## 3. 输入协议

### 3.1 命令 1: k3prefab.queryByK3Id

#### 输入示例

```json
{
  "batchId": "batch_k3_query_001",
  "timeout": 30000,
  "commands": [
    {
      "id": "cmd_query_k3button",
      "type": "k3prefab.queryByK3Id",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6,
        "componentFilter": ["K3Button"]
      }
    },
    {
      "id": "cmd_query_all_types",
      "type": "k3prefab.queryByK3Id",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 8
      }
    }
  ]
}
```

#### params 字段定义

| 参数名          | 类型     | 必填 | 默认值 | 说明                                                                       |
| --------------- | -------- | ---- | ------ | -------------------------------------------------------------------------- |
| prefabPath      | string   | 是   | -      | 预制体绝对路径                                                             |
| k3Id            | number   | 是   | -      | K3 组件的 ID（uint 类型）                                                  |
| componentFilter | string[] | 否   | null   | 组件类型过滤，如`["K3Button", "K3Label"]`，null 表示返回所有类型的匹配组件 |

### 3.2 命令 2: k3prefab.setComponentProperties

#### 输入示例

```json
{
  "batchId": "batch_k3_modify_001",
  "timeout": 30000,
  "commands": [
    {
      "id": "cmd_modify_alpha",
      "type": "k3prefab.setComponentProperties",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6,
        "index": 0,
        "modifications": [
          {
            "property": "alpha",
            "oldValue": 1.0,
            "newValue": 0.5
          },
          {
            "property": "interactable",
            "oldValue": true,
            "newValue": false
          }
        ]
      }
    },
    {
      "id": "cmd_modify_single",
      "type": "k3prefab.setComponentProperties",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 8,
        "modifications": [
          {
            "property": "text",
            "oldValue": "Old Text",
            "newValue": "New Text"
          }
        ]
      }
    }
  ]
}
```

#### params 字段定义

| 参数名        | 类型   | 必填 | 默认值 | 说明                                                         |
| ------------- | ------ | ---- | ------ | ------------------------------------------------------------ |
| prefabPath    | string | 是   | -      | 预制体绝对路径                                               |
| k3Id          | number | 是   | -      | K3 组件的 ID                                                 |
| index         | number | 否   | 0      | 同 K3ID 中的索引，用于精确定位，默认为 0（第一个匹配的组件） |
| modifications | array  | 是   | -      | 修改请求数组，每个元素包含 property、oldValue、newValue      |

#### modifications 数组元素定义

| 字段名   | 类型   | 必填 | 说明                                          |
| -------- | ------ | ---- | --------------------------------------------- |
| property | string | 是   | 属性名称，如"alpha"、"interactable"、"text"等 |
| oldValue | any    | 是   | 期望的旧值，用于验证，不匹配时跳过该属性      |
| newValue | any    | 是   | 要修改的新值                                  |

**注意**：

- 逐属性验证，每个属性独立判断
- 如果当前值与 oldValue 匹配，则修改为 newValue
- 如果当前值与 oldValue 不匹配，跳过该属性，继续处理下一个属性
- 所有属性处理完成后，返回每个属性的处理结果

## 4. 输出协议

### 4.1 命令 1: k3prefab.queryByK3Id

#### 成功输出示例

**单个匹配**：

```json
{
  "batchId": "batch_k3_query_001",
  "status": "completed",
  "startedAt": "2026-01-31 15:00:00.000",
  "finishedAt": "2026-01-31 15:00:00.500",
  "results": [
    {
      "id": "cmd_query_k3button",
      "type": "k3prefab.queryByK3Id",
      "status": "success",
      "startedAt": "2026-01-31 15:00:00.100",
      "finishedAt": "2026-01-31 15:00:00.400",
      "result": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6,
        "totalMatches": 1,
        "components": [
          {
            "index": 0,
            "gameObjectPath": "DialogMain/Panel_Content/K3Button_Confirm",
            "containerPath": "DialogMain",
            "containerType": "K3Dialog",
            "gameObjectProperties": {
              "name": "K3Button_Confirm",
              "tag": "Untagged",
              "layer": 5,
              "isActive": true,
              "isStatic": false,
              "hideFlags": 0
            },
            "k3Component": {
              "type": "K3Button",
              "instanceID": 345678901,
              "properties": {
                "interactable": true,
                "alpha": 1.0,
                "ID": 6,
                "atlasName": "CommonAtlas",
                "picName": "button_bg"
              }
            }
          }
        ]
      }
    }
  ],
  "totalCommands": 1,
  "successCount": 1,
  "failedCount": 0
}
```

**多个匹配**：

```json
{
  "result": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 42,
    "totalMatches": 2,
    "components": [
      {
        "index": 0,
        "gameObjectPath": "DialogMain/Panel_Content/K3Image_Icon",
        "containerPath": "DialogMain",
        "containerType": "K3Dialog",
        "gameObjectProperties": {
          "name": "K3Image_Icon",
          "tag": "Untagged",
          "layer": 5,
          "isActive": true
        },
        "k3Component": {
          "type": "K3Image",
          "instanceID": 456789012,
          "properties": {
            "alpha": 1.0,
            "ID": 42
          }
        }
      },
      {
        "index": 1,
        "gameObjectPath": "DialogSub/SubPanel/K3Image_Avatar",
        "containerPath": "DialogSub",
        "containerType": "K3Dialog",
        "gameObjectProperties": {
          "name": "K3Image_Avatar",
          "tag": "Untagged",
          "layer": 5,
          "isActive": true
        },
        "k3Component": {
          "type": "K3Image",
          "instanceID": 567890123,
          "properties": {
            "alpha": 0.8,
            "ID": 42
          }
        }
      }
    ]
  }
}
```

#### result 字段定义

- `prefabPath`: string, 预制体路径
- `k3Id`: number, 查询的 K3ID
- `totalMatches`: number, 匹配的 K3 组件总数
- `components`: array, 匹配的 K3 组件列表
  - 每个元素包含:
    - `index`: number, 索引（从 0 开始），用于区分多个匹配
    - `gameObjectPath`: string, GameObject 层级路径
    - `containerPath`: string, 容器 GameObject 路径（K3Dialog/K3PanelEx）
    - `containerType`: string, 容器类型（"K3Dialog"或"K3PanelEx"）
    - `gameObjectProperties`: object, GameObject 属性（name、tag、layer、isActive 等）
    - `k3Component`: object, K3 组件详细信息
      - `type`: string, K3 组件类型名
      - `instanceID`: number, Unity InstanceID
      - `properties`: object, K3 组件的所有属性（包括 ID、alpha、interactable 等）

#### 错误输出示例

**预制体不存在**：

```json
{
  "results": [
    {
      "id": "cmd_invalid_prefab",
      "type": "k3prefab.queryByK3Id",
      "status": "error",
      "error": {
        "code": "PREFAB_NOT_FOUND",
        "message": "预制体文件不存在: Assets/notexist.prefab",
        "detail": "请检查预制体路径是否正确"
      }
    }
  ]
}
```

**未找到 K3ID**：

```json
{
  "results": [
    {
      "id": "cmd_k3id_not_found",
      "type": "k3prefab.queryByK3Id",
      "status": "error",
      "error": {
        "code": "K3ID_NOT_FOUND",
        "message": "未找到K3ID为999的组件",
        "detail": "请检查K3ID是否正确，或使用prefab.queryHierarchy查看所有K3组件"
      }
    }
  ]
}
```

### 4.2 命令 2: k3prefab.setComponentProperties

#### 成功输出示例

```json
{
  "batchId": "batch_k3_modify_001",
  "status": "completed",
  "startedAt": "2026-01-31 15:00:00.000",
  "finishedAt": "2026-01-31 15:00:01.500",
  "results": [
    {
      "id": "cmd_modify_alpha",
      "type": "k3prefab.setComponentProperties",
      "status": "success",
      "startedAt": "2026-01-31 15:00:00.100",
      "finishedAt": "2026-01-31 15:00:01.200",
      "result": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6,
        "index": 0,
        "gameObjectPath": "DialogMain/Panel_Content/K3Button_Confirm",
        "componentType": "K3Button",
        "modifications": [
          {
            "property": "alpha",
            "oldValue": 1.0,
            "expectedValue": 1.0,
            "currentValue": 1.0,
            "newValue": 0.5,
            "status": "success",
            "message": "属性修改成功"
          },
          {
            "property": "interactable",
            "oldValue": true,
            "expectedValue": true,
            "currentValue": true,
            "newValue": false,
            "status": "success",
            "message": "属性修改成功"
          }
        ],
        "currentProperties": {
          "interactable": false,
          "alpha": 0.5,
          "ID": 6
        },
        "saved": true,
        "summary": {
          "total": 2,
          "success": 2,
          "skipped": 0,
          "failed": 0
        }
      }
    }
  ],
  "totalCommands": 1,
  "successCount": 1,
  "failedCount": 0
}
```

#### result 字段定义

- `prefabPath`: string, 预制体路径
- `k3Id`: number, K3 组件 ID
- `index`: number, 索引
- `gameObjectPath`: string, GameObject 路径
- `componentType`: string, K3 组件类型
- `modifications`: array, 每个属性的修改结果
  - `property`: string, 属性名
  - `oldValue`: any, 请求中提供的旧值
  - `expectedValue`: any, 期望的旧值（与 oldValue 相同）
  - `currentValue`: any, 实际修改前的值
  - `newValue`: any, 新值
  - `status`: string, 修改结果："success"（成功）、"skipped"（旧值不匹配，跳过）、"failed"（失败）
  - `message`: string, 详细说明
- `currentProperties`: object, 修改后 K3 组件的所有属性值
- `saved`: boolean, 预制体是否已保存
- `summary`: object, 修改统计
  - `total`: number, 总属性数
  - `success`: number, 成功修改数
  - `skipped`: number, 跳过数（旧值不匹配）
  - `failed`: number, 失败数

#### 部分跳过示例

```json
{
  "result": {
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "expectedValue": 1.0,
        "currentValue": 0.8,
        "newValue": 0.5,
        "status": "skipped",
        "message": "旧值不匹配，期望1.0，实际0.8，跳过修改"
      },
      {
        "property": "interactable",
        "oldValue": true,
        "expectedValue": true,
        "currentValue": true,
        "newValue": false,
        "status": "success",
        "message": "属性修改成功"
      }
    ],
    "summary": {
      "total": 2,
      "success": 1,
      "skipped": 1,
      "failed": 0
    }
  }
}
```

#### 错误输出示例

**K3ID 不存在**：

```json
{
  "results": [
    {
      "id": "cmd_k3id_not_found",
      "type": "k3prefab.setComponentProperties",
      "status": "error",
      "error": {
        "code": "K3ID_NOT_FOUND",
        "message": "未找到K3ID为999的组件",
        "detail": "请使用k3prefab.queryByK3Id先查询确认K3ID是否存在"
      }
    }
  ]
}
```

**索引超出范围**：

```json
{
  "results": [
    {
      "id": "cmd_invalid_index",
      "type": "k3prefab.setComponentProperties",
      "status": "error",
      "error": {
        "code": "INDEX_OUT_OF_RANGE",
        "message": "索引超出范围，K3ID 6只有1个匹配项（索引0），但请求了索引1",
        "detail": "请使用k3prefab.queryByK3Id查询该K3ID的匹配数量"
      }
    }
  ]
}
```

## 5. 举例覆盖需求和边缘情况

### 5.1 查询命令示例

**例 1: 查询单个 K3ID（精确匹配）**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6
  }
}
```

- 预期：
  - 返回 K3ID 为 6 的所有 K3 组件
  - 如果只有 1 个匹配，`totalMatches=1`，`components`数组只有 1 个元素
  - 返回 GameObject 路径、GameObject 属性、K3 组件详细信息

**例 2: 查询 K3ID 并过滤组件类型**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "componentFilter": ["K3Button"]
  }
}
```

- 预期：
  - 只返回 K3Button 类型的匹配组件
  - 如果 K3ID 6 对应的是 K3Label，则`totalMatches=0`，`components`为空数组

**例 3: 查询多个组件类型**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 42,
    "componentFilter": ["K3Button", "K3Label", "K3Image"]
  }
}
```

- 预期：
  - 返回 K3ID 为 42 且类型为 K3Button/K3Label/K3Image 的组件
  - 可能返回多个匹配（如果有多个容器都有 K3ID 42）

**例 4: 查询不存在的 K3ID**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 99999
  }
}
```

- 预期：
  - `status=error`
  - `error.code=K3ID_NOT_FOUND`
  - `error.message="未找到K3ID为99999的组件"`

**例 5: 预制体路径不存在**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/notexist.prefab",
    "k3Id": 6
  }
}
```

- 预期：
  - `status=error`
  - `error.code=PREFAB_NOT_FOUND`

### 5.2 修改命令示例

**例 6: 修改单个属性**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      }
    ]
  }
}
```

- 预期：
  - 如果当前 alpha 确实是 1.0，修改为 0.5，`status=success`
  - 返回修改后的 currentProperties，显示`alpha=0.5`
  - `saved=true`

**例 7: 修改多个属性**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      },
      {
        "property": "interactable",
        "oldValue": true,
        "newValue": false
      },
      {
        "property": "isRaycastTarget",
        "oldValue": true,
        "newValue": false
      }
    ]
  }
}
```

- 预期：
  - 逐属性验证，每个属性独立判断
  - `summary.total=3`
  - `summary.success=3`（假设所有旧值都匹配）
  - `modifications`数组包含 3 个元素，每个`status=success`

**例 8: 旧值不匹配被跳过**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      },
      {
        "property": "interactable",
        "oldValue": false,
        "newValue": true
      }
    ]
  }
}
```

- 假设当前`alpha=0.8`，`interactable=true`
- 预期：
  - alpha: `currentValue=0.8`，与`oldValue=1.0`不匹配，`status=skipped`
  - interactable: `currentValue=true`，与`oldValue=false`不匹配，`status=skipped`
  - `summary.total=2, summary.success=0, summary.skipped=2`
  - 命令整体`status=success`（没有失败），但没有任何属性被修改

**例 9: 部分属性成功，部分跳过**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      },
      {
        "property": "interactable",
        "oldValue": true,
        "newValue": false
      }
    ]
  }
}
```

- 假设当前`alpha=0.8`，`interactable=true`
- 预期：
  - alpha: `status=skipped`（旧值不匹配）
  - interactable: `status=success`（旧值匹配，修改为 false）
  - `summary.total=2, summary.success=1, summary.skipped=1`
  - `saved=true`（至少有一个属性被修改）

**例 10: 使用 index 指定修改第二个匹配项**

- 先查询：

```json
{
  "type": "k3prefab.queryByK3Id",
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 42
  }
}
```

- 返回：

```json
{
  "result": {
    "totalMatches": 2,
    "components": [
      {"index": 0, "gameObjectPath": "DialogMain/Panel_Content/K3Image_Icon", ...},
      {"index": 1, "gameObjectPath": "DialogSub/SubPanel/K3Image_Avatar", ...}
    ]
  }
}
```

- 修改第二个：

```json
{
  "type": "k3prefab.setComponentProperties",
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 42,
    "index": 1,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 0.8,
        "newValue": 0.3
      }
    ]
  }
}
```

- 预期：
  - 修改`DialogSub/SubPanel/K3Image_Avatar`的 alpha
  - 返回`gameObjectPath="DialogSub/SubPanel/K3Image_Avatar"`

**例 11: 索引超出范围**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "index": 5,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      }
    ]
  }
}
```

- 假设 K3ID 6 只有 1 个匹配项
- 预期：
  - `status=error`
  - `error.code=INDEX_OUT_OF_RANGE`
  - `error.message="索引超出范围，K3ID 6只有1个匹配项（索引0），但请求了索引5"`

**例 12: 属性名称错误**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": [
      {
        "property": "unknownProperty",
        "oldValue": 1.0,
        "newValue": 0.5
      }
    ]
  }
}
```

- 预期：
  - 该属性的`status=failed`
  - `message="属性unknownProperty不存在"`
  - `summary.total=1, summary.failed=1`

**例 13: 工作流：先查询后修改**

- 步骤 1：查询 K3ID

```json
{
  "batchId": "batch_workflow_001",
  "commands": [
    {
      "id": "cmd_query",
      "type": "k3prefab.queryByK3Id",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6
      }
    }
  ]
}
```

- 步骤 2：从查询结果中获取当前属性值

```json
{
  "result": {
    "components": [
      {
        "index": 0,
        "k3Component": {
          "properties": {
            "alpha": 1.0,
            "interactable": true
          }
        }
      }
    ]
  }
}
```

- 步骤 3：使用当前值作为 oldValue 进行修改

```json
{
  "batchId": "batch_workflow_002",
  "commands": [
    {
      "id": "cmd_modify",
      "type": "k3prefab.setComponentProperties",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6,
        "modifications": [
          {
            "property": "alpha",
            "oldValue": 1.0,
            "newValue": 0.5
          }
        ]
      }
    }
  ]
}
```

**例 14: 批量修改多个 K3 组件**

- 输入：

```json
{
  "batchId": "batch_multi_modify_001",
  "commands": [
    {
      "id": "cmd_modify_button",
      "type": "k3prefab.setComponentProperties",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 6,
        "modifications": [
          {
            "property": "interactable",
            "oldValue": true,
            "newValue": false
          }
        ]
      }
    },
    {
      "id": "cmd_modify_label",
      "type": "k3prefab.setComponentProperties",
      "params": {
        "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
        "k3Id": 8,
        "modifications": [
          {
            "property": "text",
            "oldValue": "Old Text",
            "newValue": "New Text"
          }
        ]
      }
    }
  ]
}
```

- 预期：
  - 两个命令都成功
  - `totalCommands=2, successCount=2`

### 5.3 边缘情况示例

**例 15: 修改后立即查询**

- 步骤 1：修改

```json
{
  "type": "k3prefab.setComponentProperties",
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      }
    ]
  }
}
```

- 步骤 2：立即查询

```json
{
  "type": "k3prefab.queryByK3Id",
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6
  }
}
```

- 预期：
  - 查询结果中的`alpha=0.5`（修改后的值）

**例 16: modifications 为空数组**

- 输入：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 6,
    "modifications": []
  }
}
```

- 预期：
  - `status=error`
  - `error.code=EMPTY_MODIFICATIONS`
  - `error.message="modifications数组不能为空"`

**例 17: 多个匹配项，不指定 index（默认 0）**

- 查询返回：

```json
{
  "totalMatches": 2,
  "components": [
    {"index": 0, "gameObjectPath": "DialogMain/Button1", ...},
    {"index": 1, "gameObjectPath": "DialogSub/Button2", ...}
  ]
}
```

- 修改时不指定 index：

```json
{
  "params": {
    "prefabPath": "Assets/ResourcesAB/UIPrefabs/DialogMain.prefab",
    "k3Id": 42,
    "modifications": [
      {
        "property": "alpha",
        "oldValue": 1.0,
        "newValue": 0.5
      }
    ]
  }
}
```

- 预期：
  - 默认`index=0`，修改第一个匹配项（`DialogMain/Button1`）
  - 返回`gameObjectPath="DialogMain/Button1"`

## 6. 验收清单（可执行）

### 6.1 批量命令框架相关

- [ ] 往`pending/`放入合法批量命令，json 会被处理，`results/`先出现 processing 再变 completed
- [ ] 批量命令中的`k3prefab.queryByK3Id`和`k3prefab.setComponentProperties`命令执行成功
- [ ] 批量命令的批次级别统计字段正确：`totalCommands`、`successCount`、`failedCount`
- [ ] 部分成功模式：某个命令失败时，后续命令继续执行

### 6.2 k3prefab.queryByK3Id 功能相关

**基本功能**：

- [ ] 查询单个 K3ID，返回匹配的 K3 组件信息
- [ ] 返回`index`索引（从 0 开始）
- [ ] 返回`gameObjectPath`（GameObject 层级路径）
- [ ] 返回`containerPath`和`containerType`（容器信息）
- [ ] 返回`gameObjectProperties`（GameObject 属性）
- [ ] 返回`k3Component.properties`（K3 组件所有属性）
- [ ] `totalMatches`正确显示匹配数量

**组件类型过滤**：

- [ ] `componentFilter: ["K3Button"]`只返回 K3Button 类型的组件
- [ ] `componentFilter: ["K3Button", "K3Label"]`返回两种类型的组件
- [ ] 如果没有匹配的类型，`totalMatches=0`，`components`为空数组
- [ ] 不提供`componentFilter`时，返回所有类型的匹配组件

**多匹配项**：

- [ ] 如果 K3ID 在多个容器中都存在，返回所有匹配项
- [ ] 每个匹配项的`index`正确（0, 1, 2...）
- [ ] 每个匹配项的`containerPath`正确（显示所属容器）

**错误处理**：

- [ ] 预制体路径不存在时，`status=error`，`error.code=PREFAB_NOT_FOUND`
- [ ] K3ID 不存在时，`status=error`，`error.code=K3ID_NOT_FOUND`

### 6.3 k3prefab.setComponentProperties 功能相关

**基本功能**：

- [ ] 修改单个属性成功，`modifications[0].status=success`
- [ ] 修改多个属性成功，`summary.success=修改数量`
- [ ] 返回`currentProperties`显示修改后的所有属性值
- [ ] 返回`saved=true`表示预制体已保存
- [ ] 修改后重新查询，新值正确反映

**旧值验证（乐观锁）**：

- [ ] 旧值匹配时，属性修改成功，`status=success`
- [ ] 旧值不匹配时，属性跳过，`status=skipped`，`message`说明原因
- [ ] 部分属性跳过时，其他属性继续处理，`summary.skipped`正确统计
- [ ] 所有属性都跳过时，命令整体`status=success`，但`summary.success=0`

**索引定位**：

- [ ] 不指定`index`时，默认为 0，修改第一个匹配项
- [ ] 指定`index=1`时，修改第二个匹配项
- [ ] `index`超出范围时，`status=error`，`error.code=INDEX_OUT_OF_RANGE`

**错误处理**：

- [ ] K3ID 不存在时，`status=error`，`error.code=K3ID_NOT_FOUND`
- [ ] 属性名称不存在时，该属性`status=failed`，`message`说明属性不存在
- [ ] `modifications`数组为空时，`status=error`，`error.code=EMPTY_MODIFICATIONS`
- [ ] 属性值类型不匹配时，该属性`status=failed`

**工作流集成**：

- [ ] 先用`k3prefab.queryByK3Id`查询，获取当前属性值
- [ ] 使用查询返回的属性值作为`oldValue`进行修改
- [ ] 修改后再次查询，验证新值正确

### 6.4 模块化要求

- [ ] 新建`Assets/Editor/AgentCommands/K3Prefab/`文件夹
- [ ] 所有 K3 相关代码都在该文件夹中
- [ ] 整个文件夹可以独立删除，不影响其他 AgentCommands 功能
- [ ] 不依赖 K3 框架之外的特定项目逻辑

## 7. 技术实现要点

### 7.1 K3 组件查找逻辑

**查找流程**：

1. 加载预制体：使用现有的`PrefabLoader.LoadPrefab()`
2. 遍历所有 K3Dialog 和 K3PanelEx 容器：
   - `gameObject.GetComponentsInChildren<K3Dialog>(true)`
   - `gameObject.GetComponentsInChildren<K3PanelEx>(true)`
3. 在每个容器的`childrenDict`或`_allChildrenDict`中查找 K3ID：
   - `dialog.childrenDict.ContainsKey(k3Id)`
   - `panel._allChildrenDict.TryGetValue(k3Id, out component)`
4. 收集所有匹配的组件，添加索引

**伪代码**：

```csharp
public static List<K3ComponentMatch> FindComponentsByK3Id(GameObject prefabRoot, uint k3Id)
{
    var matches = new List<K3ComponentMatch>();
    int index = 0;

    // 查找所有K3Dialog容器
    var dialogs = prefabRoot.GetComponentsInChildren<K3Dialog>(true);
    foreach (var dialog in dialogs)
    {
        if (dialog.childrenDict.ContainsKey(k3Id))
        {
            var component = dialog.childrenDict[k3Id];
            matches.Add(new K3ComponentMatch
            {
                index = index++,
                component = component,
                container = dialog.gameObject
            });
        }
    }

    // 查找所有K3PanelEx容器
    var panels = prefabRoot.GetComponentsInChildren<K3PanelEx>(true);
    foreach (var panel in panels)
    {
        if (panel._allChildrenDict != null && panel._allChildrenDict.ContainsKey(k3Id))
        {
            var component = panel._allChildrenDict[k3Id];
            matches.Add(new K3ComponentMatch
            {
                index = index++,
                component = component,
                container = panel.gameObject
            });
        }
    }

    return matches;
}
```

### 7.2 属性修改逻辑

**逐属性验证流程**：

1. 通过 K3ID 和索引定位到唯一的 K3 组件
2. 遍历`modifications`数组：
   - 读取当前属性值（使用 SerializedObject）
   - 比较当前值与`oldValue`
   - 如果匹配：修改为`newValue`，记录`status=success`
   - 如果不匹配：跳过，记录`status=skipped`
3. 如果有属性被修改，保存预制体
4. 返回每个属性的修改结果

**伪代码**：

```csharp
foreach (var modification in modifications)
{
    var currentValue = GetPropertyValue(component, modification.property);

    if (CompareValues(currentValue, modification.oldValue))
    {
        // 旧值匹配，执行修改
        SetPropertyValue(component, modification.property, modification.newValue);
        result.status = "success";
        result.currentValue = modification.newValue;
    }
    else
    {
        // 旧值不匹配，跳过
        result.status = "skipped";
        result.currentValue = currentValue;
        result.message = $"旧值不匹配，期望{modification.oldValue}，实际{currentValue}，跳过修改";
    }
}
```

### 7.3 代码组织建议

```
Assets/Editor/AgentCommands/
├── K3Prefab/                                        # K3预制体特化模块
│   ├── Handlers/
│   │   ├── K3PrefabQueryByK3IdHandler.cs           # 查询处理器
│   │   └── K3PrefabSetComponentPropertiesHandler.cs # 修改处理器
│   ├── Utils/
│   │   ├── K3ComponentFinder.cs                    # K3组件查找工具
│   │   ├── K3ComponentPropertyReader.cs            # K3组件属性读取
│   │   └── K3ComponentPropertyModifier.cs           # K3组件属性修改
│   └── Models/
│       ├── K3ComponentMatch.cs                      # 匹配结果模型
│       └── K3PropertyModification.cs                # 修改请求模型
├── Utils/                                           # 通用工具（复用）
│   ├── PrefabLoader.cs                              # 预制体加载
│   ├── GameObjectPathFinder.cs                      # GameObject路径
│   ├── SerializedObjectHelper.cs                    # 序列化操作
│   └── ComponentJsonBuilder.cs                      # JSON构建
└── ... (其他模块)
```

### 7.4 关键 API

| 功能类别    | API/方法                                           | 说明                 |
| ----------- | -------------------------------------------------- | -------------------- |
| 预制体加载  | `PrefabLoader.LoadPrefab()`                        | 复用现有工具         |
| K3 组件查找 | `K3Dialog.childrenDict.ContainsKey(k3Id)`          | 在 Dialog 中查找     |
| K3 组件查找 | `K3PanelEx._allChildrenDict.TryGetValue()`         | 在 PanelEx 中查找    |
| 属性读取    | `SerializedObjectHelper.GetSerializedProperties()` | 复用现有工具         |
| 属性写入    | `SerializedObjectHelper.SetSerializedProperty()`   | 扩展或新增           |
| 预制体保存  | `PrefabUtility.SaveAsPrefabAsset()`                | 保存预制体到磁盘     |
| 容器遍历    | `GetComponentsInChildren<K3Dialog>(true)`          | 查找所有 Dialog 容器 |

### 7.5 K3 框架类型依赖

**必须引用的 K3 类型**：

```csharp
using K3Engine.Component;
using K3Engine.Component.Interfaces;

// 核心接口
IK3Component     // 所有K3组件的基础接口
IK3Container     // 容器接口（K3Dialog、K3Panel等）

// 核心类
K3Property       // K3属性对象，包含ID、parentID、maxID
K3Dialog         // Dialog容器
K3PanelEx        // Panel扩展容器

// 常用组件类型（用于componentFilter）
K3Button
K3Label
K3Image
K3Edit
K3CheckBox
// ... 其他K3组件类型
```

**注意事项**：

- 本模块完全依赖 K3 框架类型，不适配其他项目
- 移除 K3 框架时，整个`K3Prefab`模块需要一并删除
- 不引入其他项目特定的依赖

### 7.6 参数验证要点

**k3prefab.queryByK3Id**：

- 验证预制体路径存在且有效
- 验证 k3Id 为正整数（uint 范围）
- 验证 componentFilter 中的类型名是否为有效的 K3 组件类型

**k3prefab.setComponentProperties**：

- 验证预制体路径存在且有效
- 验证 k3Id 存在
- 验证 index 在有效范围内（0 到 totalMatches-1）
- 验证 modifications 数组不为空
- 验证 property 名称存在
- 验证 oldValue 和 newValue 类型正确

## 8. 与现有命令的对比

### 8.1 功能对比

| 命令                                      | 定位方式        | 返回内容                | 适用场景             |
| ----------------------------------------- | --------------- | ----------------------- | -------------------- |
| `prefab.queryHierarchy`                   | GameObject 层级 | 层级结构                | 查看预制体结构       |
| `prefab.queryComponents`                  | GameObject 路径 | GameObject 上的所有组件 | 查看 GameObject 组件 |
| `k3prefab.queryByK3Id`（新增）            | K3ID            | K3 组件详细信息         | 快速查找 K3 组件     |
| `prefab.setGameObjectProperties`          | GameObject 路径 | GameObject 属性         | 修改 GameObject      |
| `k3prefab.setComponentProperties`（新增） | K3ID            | K3 组件属性             | 修改 K3 组件属性     |

### 8.2 优势对比

**k3prefab.queryByK3Id 的优势**：

- 直接通过 K3ID 定位，无需知道 GameObject 路径
- 返回 K3 组件的详细信息（包括 IK3Component 接口的所有属性）
- 自动处理多容器场景，返回所有匹配项
- 支持按 K3 组件类型过滤

**k3prefab.setComponentProperties 的优势**：

- 直接通过 K3ID 定位，与 Lua 代码中的使用方式一致
- 乐观锁机制，避免误修改
- 逐属性验证，部分失败不影响其他属性
- 专门处理 K3 组件的特殊属性（如 alpha、interactable 等）

## 9. 后续扩展方向

### 9.1 可能的扩展功能

- 批量查询多个 K3ID：`k3prefab.queryMultipleK3Ids`
- K3 组件事件绑定查询：查询 K3Button 的点击事件等
- K3 组件添加/删除：支持在预制体中添加或删除 K3 组件
- K3ID 冲突检测：扫描预制体中所有 K3ID，检测重复
- K3ID 重分配：批量调整 K3ID 范围

### 9.2 跨项目适配考虑

如果需要适配其他项目（不使用 K3 框架）：

1. 整个`K3Prefab`模块可以独立删除
2. 或者：
   - 抽象出组件 ID 接口：`IComponentId`
   - 实现 K3 框架适配器：`K3ComponentIdAdapter`
   - 实现其他 UI 框架适配器：`UGUIComponentIdAdapter`、`UI Toolkit适配器`

但当前需求明确 K3 功能是项目特化的，不需要考虑跨项目适配。

---

用户对 K3UI 框架的补充:
K3DialogEx 下会有 多个 K3Panel,
且 K3DialogEx 一般为预制体根节点
K3Panel 也可作为 预制体根节点,会加载到 K3DialogEx 或者其他 K3Panel 中 使用

K3PanelEx.cs 不会作为组件加到 gameobject 中 好像是专给 lua 层用的?

典型的一个 K3Dialog 为根节点的预制体长这样:
Code/Assets/Assets/ResourcesAB/UIPrefabs/LotteryDialog.prefab
self.content = self:getPanel(3)
self.LotteryPanel = self:getPanel(241)
self.LotteryDrawPanel = self:getPanel(4)
self.SkipAnimButton = self:getButton(104)
self.SkipAnimButton:AddEventListener(function(args) end)
self.OncebtnPanel = self:getPanel(204)
self.IconImage = self:getImage(205)
self.CostLabel = self:getLabel(206)
self.OnceButton = self:getButton(109)
self.OnceButton:AddEventListener(function(args) end)
self.TenTimesPanel = self:getPanel(207)
self.IconImage = self:getImage(208)
self.CostLabel = self:getLabel(209)
self.TenTimesButton = self:getButton(110)
self.TenTimesButton:AddEventListener(function(args) end)
self.AwardDisplayButton = self:getButton(203)
self.AwardDisplayButton:AddEventListener(function(args) end)
self.ProbabilityFormulaLabelButton = self:getLabelButton(211)
self.ProbabilityFormulaLabelButton:AddEventListener(function(args) end)
self.eggAnimPanel = self:getPanel(291)
self.EggCrackImage = self:getImage(292)
self.LotteryResultPanel = self:getPanel(242)
self.ItemsPanel = self:getPanel(244)
self.TenTimesPanel = self:getPanel(257)
self.IconImage = self:getImage(258)
self.CostLabel = self:getLabel(259)
self.TenTimesButton = self:getButton(260)
self.TenTimesButton:AddEventListener(function(args) end)
self.OKButton = self:getButton(256)
self.OKButton:AddEventListener(function(args) end)
self.LotteryDisplayPanel = self:getPanel(261)
self.InsightImage = self:getInsightImage(265)
self.titlePanel = self:getPanel(266)
self.TitelLabel = self:getLabel(267)
self.SkillsPanel = self:getPanel(268)
self.SkillItemPanel = self:getPanel(269)
self.SkillIconImage = self:getImage(270)
self.LVLabel = self:getLabel(271)
self.SkillInfoLabel = self:getLabel(272)
self.iconImage = self:getImage(285)
self.TipsLabel = self:getLabel(288)
self.tabsListView_listView = self:getListView(143)
self:SetListView(143, itemid, "Logics.path.Lua 脚本不含后缀名的文件名")
self.tanItemPanel = self:getPanel(145)
self.BoxPanel = self:getPanel(158)
self.Image_174 = self:getImage(174)
self.Image_174 (1) = self:getImage(175)
self.Image_174 (2) = self:getImage(176)
self.Animation_112 = self:getAnimation(200)
self.Label_177 = self:getLabel(177)
self.Label_177 (1) = self:getLabel(199)
self.Image_171 = self:getImage(171)
self.Panel_162 = self:getPanel(162)
self.Image_172 = self:getImage(172)
self.Image_163 = self:getImage(163)
self.Image_165 = self:getImage(165)
self.Label_166 = self:getLabel(166)
self.Button_168 = self:getButton(168)
self.Button_168:AddEventListener(function(args) end)
self.Animation_167 = self:getAnimation(167)
self.Panel_162 (1) = self:getPanel(178)
self.Image_172 = self:getImage(179)
self.Image_163 = self:getImage(180)
self.Image_165 = self:getImage(181)
self.Label_166 = self:getLabel(182)
self.Button_168 = self:getButton(183)
self.Button_168:AddEventListener(function(args) end)
self.Animation_167 = self:getAnimation(184)
self.Panel_162 (2) = self:getPanel(185)
self.Image_172 = self:getImage(186)
self.Image_163 = self:getImage(187)
self.Image_165 = self:getImage(188)
self.Label_166 = self:getLabel(189)
self.Button_168 = self:getButton(190)
self.Button_168:AddEventListener(function(args) end)
self.Animation_167 = self:getAnimation(191)
self.Panel_162 (3) = self:getPanel(192)
self.Image_172 = self:getImage(193)
self.Image_163 = self:getImage(194)
self.Image_165 = self:getImage(195)
self.Label_166 = self:getLabel(196)
self.Button_168 = self:getButton(197)
self.Button_168:AddEventListener(function(args) end)
self.Animation_167 = self:getAnimation(198)
self.Prizedrawn_160 = self:getLabel(160)
self.closebtn = self:getButton(1)
self.closebtn:AddEventListener(function(args) end)
self.ProbabilityFormulaPanel = self:getPanel(213)
self.contentPanel = self:getPanel(215)
self.closeButton = self:getButton(216)
self.closeButton:AddEventListener(function(args) end)
self.titleLabel = self:getLabel(217)
self.LegendPanel = self:getPanel(218)
self.LegendItemPanel = self:getPanel(219)
self.QualityImage = self:getImage(221)
self.ProbabilityLabel = self:getLabel(222)
self.ListView_listView = self:getListView(233)
self:SetListView(233, itemid, "Logics.path.Lua 脚本不含后缀名的文件名")
self.ItemPanel = self:getPanel(234)
self.QualityImage = self:getImage(235)
self.Itembox = self:getItembox(236)
self.NameLabel = self:getLabel(237)
self.InfoLabel = self:getLabel(238)
self.ProbabilityLabel = self:getLabel(239)
self.TipsLabel = self:getLabel(240)
self.AwardDisplayPanel = self:getPanel(150)
self.contentPanel = self:getPanel(212)
self.AwardDisplayListView_listView = self:getListView(151)
self:SetListView(151, itemid, "Logics.path.Lua 脚本不含后缀名的文件名")
self.AwardDisplayItemPanel = self:getPanel(152)
self.time_153 = self:getLabel(153)
self.playername_154 = self:getLabel(154)
self.name_154 (1) = self:getLabel(155)
self.itemname_157 = self:getLabelButton(157)
self.itemname_157:AddEventListener(function(args) end)
self.CloseButton = self:getButton(210)
self.CloseButton:AddEventListener(function(args) end)

一个典型的 K3Panel 为根节点的预制体长这样:
self.strongpanel_xsgl = self:getPanel(126)
self.rightList_listView = self:getListView(124)
self.rightList_listView = self:getListView(149)
self.rightTempPanel = self:getPanel(116)
self.xinshougonglue = self:getImage(0)
self.icon = self:getImage(140)
self.NumLabel = self:getLabel(141)
self.iconS1 = self:getImage(150)
self.NumLabel = self:getLabel(151)
self.iconS2 = self:getImage(152)
self.receiveBtn = self:getButton(142)
self.receiveBtn:AddEventListener(function(args) end)
self.text = self:getLabel(127)
self.contentLabel = self:getLabel(139)
self.rightItemPanel = self:getPanel(143)
self.contentLabel = self:getLabel(148)

==========以上已完成

需要新增个技能包含本需求的两个指令和 `prefab.setGameObjectProperties`指令
参考 requirements/AgentCommands/04\_预制体编辑 01.md

参考 F:\UnityProject\SL\SL*402\Code\Assets\Editor\AgentCommands\SkillsExporter
requirements/AgentCommands/99*用户界面插件与 skill 和脚本生成.md
制作新的 k3-prefab 技能
